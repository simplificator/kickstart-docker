version: v1.0
name: Build and Deploy docker container
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Unit tests"
    task:
      jobs:
        - name: RSpec
          commands:
            - checkout
            - echo "make rspec"

        - name: Lint code
          commands:
            - checkout
            - echo "make lint"

        - name: Check security
          commands:
            - checkout
            - echo "make security"

  - name: "Build and Push"
    task:
      env_vars:
        - name: IMAGE
          value: 135594858514.dkr.ecr.eu-central-1.amazonaws.com/simplificator/kickstart
        - name: AWS_DEFAULT_REGION
          value: eu-central-1
      secrets:
        - name: kickstart-aws
      prologue:
        commands:
          - sudo pip install awscli
          - checkout
          - aws ecr get-login --no-include-email | bash
      jobs:
        - name: Docker build
          commands:
            - ls -1
            - docker build -t $IMAGE:$SEMAPHORE_GIT_BRANCH .
            - docker images
            - docker push $IMAGE:$SEMAPHORE_GIT_BRANCH

  - name: "Integration tests"
    task:
      jobs:
        - name: Cucumber
          commands:
            - checkout
            - echo "make cucumber"
